<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Visits</title>

<style>
body{
  font-family: Arial;
  background:#f4f4f4;
  padding:20px;
}
input, select{
  padding:8px;
  width:320px;
  margin:6px 0;
}
.section{
  background:#fff;
  padding:15px;
  margin-top:15px;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,.2);
}
.label{
  font-weight:bold;
  margin-top:10px;
}
</style>
</head>

<body>

<h2>Delivery Visits</h2>

<div class="section">
  <div class="label">Search Store</div>
  <input type="text" id="storeSearch" placeholder="Type P001">

  <select id="storeSelect">
    <option value="">Select Store</option>
  </select>
</div>

<div class="section" id="deliveryInfo">
  No store selected
</div>

<div class="section">
  <div class="label">Search Material</div>
  <input type="text" id="materialSearch" placeholder="102468 or Omiz">
</div>

<div class="section" id="materialInfo">
  No material selected
</div>

<script>
const deliveryURL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSXlvP1WVT_NHTcqNPp-bv0_Renbo-PXFsLPOssgOi1TSjWjTuqRyUAH5boHUwoZsRUo5cvwT2I_1K-/pub?gid=0&single=true&output=csv";

const availabilityURL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQDJxjTG91GO_Lh5008Lrtl4ZcQnxOXY2O1P0BNVVWEDdRsJrIDnMPIWHAsoGJ7D1_R7og9It0woY_W/pub?gid=0&single=true&output=csv";

let deliveryData = [];
let availabilityData = [];
let selectedWH = "";

/* CSV */
function csvToArray(csv){
  const lines = csv.trim().split("\n");
  const headers = lines.shift().split(",");
  return lines.map(l=>{
    const o = {};
    l.split(",").forEach((v,i)=>o[headers[i].trim()] = v.trim());
    return o;
  });
}

/* LOAD */
Promise.all([
  fetch(deliveryURL).then(r=>r.text()),
  fetch(availabilityURL).then(r=>r.text())
]).then(([d,a])=>{
  deliveryData = csvToArray(d);
  availabilityData = csvToArray(a);
  loadStores();
});

/* STORES */
function loadStores(){
  const sel = document.getElementById("storeSelect");
  [...new Set(deliveryData.map(d=>d.STORE))].sort().forEach(s=>{
    const o = document.createElement("option");
    o.value = s;
    o.textContent = s;
    sel.appendChild(o);
  });
}

/* SHOW STORE */
function showStore(store){
  const r = deliveryData.find(d=>d.STORE === store);
  if(!r){
    document.getElementById("deliveryInfo").innerHTML = "Store not found";
    return;
  }

  selectedWH = r.wh.toUpperCase();

  document.getElementById("deliveryInfo").innerHTML = `
    <b>City:</b> ${r.city}<br>
    <b>Store:</b> ${r.STORE}<br>
    <b>WH:</b> ${r.wh}<br>
    <b>Visit Days:</b><br>
    ${r["1ST"] || ""}<br>
    ${r["2ND"] || ""}<br>
    ${r["3RD"] || ""}
  `;
}

/* EVENTS */
storeSelect.onchange = e=>{
  storeSearch.value = e.target.value;
  showStore(e.target.value);
};

storeSearch.oninput = e=>{
  const v = e.target.value.toUpperCase();
  storeSelect.value = v;
  showStore(v);
};

/* MATERIAL SEARCH */
materialSearch.oninput = function(){
  const v = this.value.toLowerCase();
  if(!selectedWH || v.length < 2) return;

  const r = availabilityData.find(a =>
    a.Material.toLowerCase().includes(v) ||
    a["Material Description"].toLowerCase().includes(v)
  );

  if(!r){
    materialInfo.innerHTML = "Material not found";
    return;
  }

  const status = selectedWH === "W1" ? r.wh1 : r.wh2;

  materialInfo.innerHTML = `
    <b>Material:</b> ${r.Material}<br>
    <b>Description:</b> ${r["Material Description"]}<br>
    <b>Status:</b> ${status}
  `;
};
</script>

</body>
</html>
