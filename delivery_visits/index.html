<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Visits</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}
select, input {
  padding:8px;
  margin:10px 0;
  width:300px;
}
.box {
  background:#fff;
  padding:15px;
  margin-top:15px;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,.2);
}
h3 {
  margin-top:0;
}
</style>
</head>

<body>

<h2>Delivery Visits</h2>

<!-- STORE DROPLIST -->
<label>Select Store</label><br>
<select id="storeSelect">
  <option value="">-- Select Store --</option>
</select>

<!-- MATERIAL SEARCH -->
<br>
<label>Search Material (Number or Description)</label><br>
<input type="text" id="materialSearch" placeholder="e.g. 102468 or Omiz">

<!-- OUTPUT 1 -->
<div class="box">
  <h3>OUTPUT #1 – Delivery Info</h3>
  <div id="output1">No data</div>
</div>

<!-- OUTPUT 2 -->
<div class="box">
  <h3>OUTPUT #2 – Material Availability</h3>
  <div id="output2">No data</div>
</div>

<script>
const deliveryURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXlvP1WVT_NHTcqNPp-bv0_Renbo-PXFsLPOssgOi1TSjWjTuqRyUAH5boHUwoZsRUo5cvwT2I_1K-/pub?gid=0&single=true&output=csv";
const availabilityURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDJxjTG91GO_Lh5008Lrtl4ZcQnxOXY2O1P0BNVVWEDdRsJrIDnMPIWHAsoGJ7D1_R7og9It0woY_W/pub?gid=0&single=true&output=csv";

let deliveryData = [];
let availabilityData = [];
let selectedWH = "";

/* CSV TO ARRAY */
function csvToArray(csv) {
  const lines = csv.trim().split("\n");
  const headers = lines.shift().split(",");
  return lines.map(line => {
    const obj = {};
    line.split(",").forEach((v,i)=>obj[headers[i].trim()] = v.trim());
    return obj;
  });
}

/* LOAD DATA */
Promise.all([
  fetch(deliveryURL).then(r=>r.text()),
  fetch(availabilityURL).then(r=>r.text())
]).then(([d,a])=>{
  deliveryData = csvToArray(d);
  availabilityData = csvToArray(a);
  fillStoreList();
});

/* FILL STORE DROPLIST */
function fillStoreList() {
  const stores = [...new Set(deliveryData.map(d=>d.STORE))].sort();
  const sel = document.getElementById("storeSelect");
  stores.forEach(s=>{
    const op = document.createElement("option");
    op.value = s;
    op.textContent = s;
    sel.appendChild(op);
  });
}

/* STORE CHANGE */
document.getElementById("storeSelect").addEventListener("change", function(){
  const store = this.value;
  const row = deliveryData.find(d=>d.STORE === store);
  if(!row) return;

  selectedWH = row.wh.toUpperCase();

  document.getElementById("output1").innerHTML = `
    <b>City:</b> ${row.city}<br>
    <b>WH:</b> ${row.wh}<br>
    <b>Store:</b> ${row.STORE}<br>
    <b>1ST:</b> ${row["1ST"]}<br>
    <b>2ND:</b> ${row["2ND"]}<br>
    <b>3RD:</b> ${row["3RD"]}
  `;
});

/* MATERIAL SEARCH */
document.getElementById("materialSearch").addEventListener("input", function(){
  const val = this.value.toLowerCase();
  if(val.length < 2 || !selectedWH) return;

  const row = availabilityData.find(a =>
    a.Material.toLowerCase().includes(val) ||
    a["Material Description"].toLowerCase().includes(val)
  );

  if(!row){
    document.getElementById("output2").innerHTML = "No material found";
    return;
  }

  const status = selectedWH === "W1" ? row.wh1 : row.wh2;

  document.getElementById("output2").innerHTML = `
    <b>Material:</b> ${row.Material}<br>
    <b>Description:</b> ${row["Material Description"]}<br>
    <b>Status:</b> ${status}
  `;
});
</script>

</body>
</html>
