<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Visits</title>

<style>
body{
  font-family:Arial;
  background:#f4f4f4;
  padding:20px;
}
input, select{
  padding:8px;
  width:300px;
  margin:6px 0;
}
.box{
  background:#fff;
  padding:15px;
  margin-top:15px;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,.2);
}
h3{margin-top:0}
</style>
</head>

<body>

<h2>Delivery Visits</h2>

<!-- STORE SEARCH -->
<label>Search Store (Typing)</label><br>
<input type="text" id="storeSearch" placeholder="P001">

<br>

<label>Select Store (Droplist)</label><br>
<select id="storeSelect">
  <option value="">-- Select Store --</option>
</select>

<br><br>

<label>Search Material (Number or Description)</label><br>
<input type="text" id="materialSearch" placeholder="102468 or Omiz">

<!-- OUTPUT 1 -->
<div class="box">
  <h3>OUTPUT #1 – Store Info</h3>
  <div id="output1">No data</div>
</div>

<!-- OUTPUT 2 -->
<div class="box">
  <h3>OUTPUT #2 – Availability</h3>
  <div id="output2">No data</div>
</div>

<script>
const deliveryURL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSXlvP1WVT_NHTcqNPp-bv0_Renbo-PXFsLPOssgOi1TSjWjTuqRyUAH5boHUwoZsRUo5cvwT2I_1K-/pub?gid=0&single=true&output=csv";

const availabilityURL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQDJxjTG91GO_Lh5008Lrtl4ZcQnxOXY2O1P0BNVVWEDdRsJrIDnMPIWHAsoGJ7D1_R7og9It0woY_W/pub?gid=0&single=true&output=csv";

let deliveryData = [];
let availabilityData = [];
let currentWH = "";

/* CSV PARSER */
function csvToArray(csv){
  const lines = csv.trim().split("\n");
  const headers = lines.shift().split(",");
  return lines.map(l=>{
    const obj = {};
    l.split(",").forEach((v,i)=>obj[headers[i].trim()] = v.trim());
    return obj;
  });
}

/* LOAD DATA */
Promise.all([
  fetch(deliveryURL).then(r=>r.text()),
  fetch(availabilityURL).then(r=>r.text())
]).then(([d,a])=>{
  deliveryData = csvToArray(d);
  availabilityData = csvToArray(a);
  fillStoreList();
});

/* DROPLIST */
function fillStoreList(){
  const stores = [...new Set(deliveryData.map(d=>d.STORE))].sort();
  const sel = document.getElementById("storeSelect");
  stores.forEach(s=>{
    const o = document.createElement("option");
    o.value = s;
    o.textContent = s;
    sel.appendChild(o);
  });
}

/* SHOW STORE INFO */
function showStore(store){
  const row = deliveryData.find(d=>d.STORE === store);
  if(!row) return;

  currentWH = row.wh.toUpperCase().trim();

  document.getElementById("output1").innerHTML = `
    <b>City:</b> ${row.city}<br>
    <b>WH:</b> ${row.wh}<br>
    <b>Store:</b> ${row.STORE}<br>
    <b>1ST:</b> ${row["1ST"]}<br>
    <b>2ND:</b> ${row["2ND"]}<br>
    <b>3RD:</b> ${row["3RD"]}
  `;
}

/* DROPLIST EVENT */
document.getElementById("storeSelect").addEventListener("change", e=>{
  document.getElementById("storeSearch").value = e.target.value;
  showStore(e.target.value);
});

/* SEARCH STORE EVENT */
document.getElementById("storeSearch").addEventListener("input", e=>{
  const v = e.target.value.toUpperCase();
  document.getElementById("storeSelect").value = v;
  showStore(v);
});

/* MATERIAL SEARCH */
document.getElementById("materialSearch").addEventListener("input", function(){
  const v = this.value.toLowerCase();
  if(!currentWH || v.length < 2) return;

  const row = availabilityData.find(a =>
    a.Material.toLowerCase().includes(v) ||
    a["Material Description"].toLowerCase().includes(v)
  );

  if(!row){
    document.getElementById("output2").innerHTML = "No material found";
    return;
  }

  let status = "";
  if(currentWH === "W1") status = row.wh1;
  if(currentWH === "W2") status = row.wh2;

  document.getElementById("output2").innerHTML = `
    <b>Material:</b> ${row.Material}<br>
    <b>Description:</b> ${row["Material Description"]}<br>
    <b>Status:</b> ${status}
  `;
});
</script>

</body>
</html>
